# 作業ログ 2026-02-17

## 指示内容

WebUI 実装計画に基づき、単一ファイル CLI ツールをモノレポ構成に分割。

## 作業内容

### Phase 1: shared パッケージ抽出

- `/Users/t.okada/work/twitter-movie-downloader/packages/shared/` 作成
- 純粋関数・型・定数を個別ファイルに分割
  - `types.ts`: `VideoVariant`, `MediaInfo`, `TweetInfoResponse`, `ApiErrorResponse`
  - `consts.ts`: `GRAPHQL_QUERY_ID`, `GRAPHQL_FEATURES`（as const 追加）
  - `extract-tweet-id.ts`, `extract-media-info.ts`, `sanitize-output-path.ts`, `validate-video-url.ts`, `build-graphql-url.ts`
  - `mod.ts`: re-export エントリ
- ルート `deno.json` を workspace 化
- `biome.json` の includes を `**/*.ts` に修正、VCS 有効化、Vue SFC の lint override 追加
- テスト31件通過

### Phase 2: CLI パッケージ移行

- `/Users/t.okada/work/twitter-movie-downloader/packages/cli/` 作成
- `TwitterVideoDownloader` クラスを移行、`@tmd/shared` から import
- `buildGraphqlUrl` で URL 構築ロジックを共有関数に委譲
- `DEFAULT_BEARER_TOKEN` は CLI 内に保持（API は環境変数必須）

### Phase 3: API パッケージ作成

- `/Users/t.okada/work/twitter-movie-downloader/packages/api/` 作成
- **ユーザー指示により Hono フレームワークを採用**（当初計画の素の Deno.serve から変更）
- `twitter-client.ts`: Guest Token キャッシュ（TTL 30分）、`fetchTweetMedia`
- `handlers/health.ts`, `handlers/tweet-info.ts`
- CORS: Hono 組み込み `cors()` ミドルウェア
- テスト3件通過

### Phase 4: WebUI パッケージ作成

- `/Users/t.okada/work/twitter-movie-downloader/packages/web/` 作成
- Vue3 + Vite 構成
- コンポーネント: `TweetUrlInput.vue`, `VideoResultList.vue`, `ErrorMessage.vue`
- composable: `useTweetDownload.ts`（API 通信 + 状態管理）
- `nodeModulesDir: "auto"` はルート deno.json に配置（workspace 制約）
- Vite ビルド成功

### Phase 5: PBT テスト追加

- `npm:fast-check@4.5.3` を使用
- fast-check v4 API 変更: `stringOf` → `string({ unit: ... })`
- PBT 7件追加:
  - `extractTweetId`: round-trip、digit-only invariant
  - `sanitizeOutputPath`: パス区切り不変条件、デフォルトファイル名、非空文字列
  - `validateVideoUrl`: 非 HTTPS で必ずエラー
  - `buildGraphqlUrl`: 有効 URL + tweetId 含有
- PBT が `sanitizeOutputPath("", "/")` のエッジケースを発見（tweetId に `/` 含む場合）

### Phase 6: CI/CD + デプロイ設定

- `/Users/t.okada/work/twitter-movie-downloader/.github/workflows/ci.yml`: Lint + Type check + Test
- `/Users/t.okada/work/twitter-movie-downloader/.github/workflows/deploy-web.yml`: GitHub Pages
- `/Users/t.okada/work/twitter-movie-downloader/.github/workflows/deploy-api.yml`: Deno Deploy

### Phase 7: クリーンアップ

- 旧ファイル削除: `twitter-movie-downloader.ts`, `twitter-movie-downloader.test.ts`
- `.env.example` 更新（CLI/API/WebUI の環境変数）
- `.envrc` 作成（direnv: `dotenv_if_exists`）
- `.gitignore` 更新（`dist/`, `node_modules/` 追加）

## 技術判断

| 判断 | 理由 |
|------|------|
| Hono 採用 | ユーザー指示。軽量で Deno Deploy ネイティブ互換 |
| `types.ts` / `consts.ts` 命名 | ユーザー指示 |
| `as const` 追加（GRAPHQL_FEATURES） | 型推論の厳密化 |
| Vue SFC の Biome lint override | Biome が script setup + template の関係を理解できない |
| `nodeModulesDir: "auto"` をルートに配置 | Deno workspace 制約 |
| Biome VCS 有効化 | dist/ 等ビルド成果物の除外に必要 |
| direnv 導入 | ユーザー指示。`.envrc` で `dotenv_if_exists` を使用 |

## 最終状態

- テスト: 164件全通過（うち PBT 7件）
- Lint: パス
- 型チェック: パス

---

## mp4/mov フォーマット選択ダウンロード機能

### 指示内容

WebUI + CLI で mp4/mov フォーマットを選択してダウンロードできる機能を追加。MOV は H.264 in MOV コンテナ（`ffmpeg -c copy -f mov` でリマックス）。

### 作業内容

#### Phase 1: shared — 型・バリデーション追加

- `/Users/t.okada/work/twitter-movie-downloader/packages/shared/types.ts`: `VideoFormat = "mp4" | "mov"` 型追加
- `/Users/t.okada/work/twitter-movie-downloader/packages/shared/validate-format.ts`: 新規作成。`validateFormat()` 関数
- `/Users/t.okada/work/twitter-movie-downloader/packages/shared/__tests__/validate-format.test.ts`: 新規作成。UT 5件 + PBT 2件
- `/Users/t.okada/work/twitter-movie-downloader/packages/shared/sanitize-output-path.ts`: `format` パラメータ追加（デフォルト `"mp4"`）。拡張子を format に基づいて置換
- `/Users/t.okada/work/twitter-movie-downloader/packages/shared/__tests__/sanitize-output-path.test.ts`: format テスト 6件 + PBT 2件追加
- `/Users/t.okada/work/twitter-movie-downloader/packages/shared/mod.ts`: `VideoFormat`, `validateFormat` の export 追加

#### Phase 2: API — ダウンロードエンドポイント

- `/Users/t.okada/work/twitter-movie-downloader/packages/api/handlers/tweet-download.ts`: 新規作成
  - `GET /api/tweet/:id/download?quality=<quality>&format=mp4|mov`
  - mp4: Twitter CDN からストリーミングプロキシ（`Content-Disposition: attachment`）
  - mov: 一時ファイルにダウンロード → `ffmpeg -c copy -f mov` → レスポンス → 一時ファイル削除
  - HLS: `ffmpeg -c copy` で変換（format に応じて mp4/mov 出力）
- `/Users/t.okada/work/twitter-movie-downloader/packages/api/__tests__/tweet-download.test.ts`: 新規作成。バリデーションテスト 4件
- `/Users/t.okada/work/twitter-movie-downloader/packages/api/mod.ts`: ルート追加
- `/Users/t.okada/work/twitter-movie-downloader/deno.json`: `dev:api` に `--allow-run --allow-read --allow-write` 追加

#### Phase 3: CLI — `--format` フラグ

- `/Users/t.okada/work/twitter-movie-downloader/packages/cli/mod.ts`: `parseArgs()` 関数追加。`--format mp4|mov` オプション対応
- `/Users/t.okada/work/twitter-movie-downloader/packages/cli/downloader.ts`: `download()` に `format` パラメータ追加。`remuxToMov()` メソッド追加

#### Phase 4: WebUI — フォーマット選択 UI

- `/Users/t.okada/work/twitter-movie-downloader/packages/web/src/components/VideoResultList.vue`: フォーマット select 追加。ダウンロードリンクを API プロキシ URL に変更

#### Phase 5: 検証・クリーンアップ

- テスト: 60件全通過（shared 53件 + API 7件）
- Lint: パス（biome format + import sort 自動修正）
- 型チェック: 3パッケージ（shared, api, cli）全通過

### 技術判断

| 判断 | 理由 |
|------|------|
| API プロキシ経由ダウンロード | Twitter CDN の CORS 不安定 + `Content-Disposition` ヘッダー付与 |
| MOV は `ffmpeg -c copy -f mov` | 再エンコード不要、コンテナ変更のみ。ほぼ瞬時 |
| mp4 はストリーミングプロキシ | メモリ節約。ReadableStream をそのままパイプ |
| MOV 変換は一時ファイル経由 | FFmpeg の MOV 出力はシーク可能ファイルが必要 |
| `sanitizeOutputPath` で常に拡張子付与 | format パラメータに基づき正しい拡張子を保証 |
